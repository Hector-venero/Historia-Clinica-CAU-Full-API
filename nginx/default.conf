# =====================================================
# üåê CONFIGURACI√ìN NGINX - HISTORIA CL√çNICA BFA
# -----------------------------------------------------
# - Entorno local: http://localhost
# - Entorno productivo: https://historia-cau.unsam.edu.ar
# =====================================================

##############################
# üîπ BLOQUE HTTP (ENTORNO LOCAL)
##############################
server {
    listen 80;
    server_name historia.local;

    # üöÄ Si est√°s en producci√≥n, descoment√° la l√≠nea siguiente para redirigir a HTTPS:
    # return 301 https://$host$request_uri;

    # üìÅ Servir el frontend React (Vite build -> ./frontend/dist)
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }

    # üîó Redirigir llamadas /api/ al backend Flask (contenedor "web")
    location /api/ {
        proxy_pass http://web:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # üß± Cabeceras de seguridad HTTP
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # ‚ö†Ô∏è Errores comunes
    error_page 404 /index.html;
    error_page 500 502 503 504 /index.html;
}

##############################
# üîí BLOQUE HTTPS (ENTORNO PRODUCTIVO)
##############################
# ‚ö†Ô∏è Este bloque queda comentado hasta tener dominio y certificados SSL v√°lidos.
# Una vez tengas el dominio, descoment√° todo este bloque y reemplaz√°
# "historia-cau.unsam.edu.ar" por tu dominio real.

# server {
#     listen 443 ssl;
#     server_name historia-cau.unsam.edu.ar;

#     # üìú Certificados SSL de Let's Encrypt (se crean con certbot)
#     ssl_certificate /etc/letsencrypt/live/historia-cau.unsam.edu.ar/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/historia-cau.unsam.edu.ar/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;

#     # üìÅ Servir el frontend (build de React)
#     location / {
#         root /usr/share/nginx/html;
#         index index.html index.htm;
#         try_files $uri $uri/ /index.html;
#     }

#     # üîó Proxy para backend Flask
#     location /api/ {
#         proxy_pass http://web:5000/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }

#     # üß± Seguridad avanzada
#     add_header X-Frame-Options "SAMEORIGIN";
#     add_header X-Content-Type-Options "nosniff";
#     add_header X-XSS-Protection "1; mode=block";
#     add_header Referrer-Policy "strict-origin-when-cross-origin";

#     # üîÑ Redirecci√≥n HTTP->HTTPS autom√°tica
#     # (Certbot la agrega tambi√©n autom√°ticamente al instalar)
#     error_page 404 /index.html;
#     error_page 500 502 503 504 /index.html;
# }
