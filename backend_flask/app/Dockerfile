# ===========================================
# üêç Flask Backend - H√≠brido (Dev / Prod)
# ===========================================

FROM python:3.12-slim

# üîß Variables de entorno seguras
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    FLASK_APP=main.py \
    TZ=America/Argentina/Buenos_Aires

WORKDIR /app

# ===========================================
# üß± Dependencias del sistema
# ===========================================
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    curl \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

# ===========================================
# üì¶ Copiar archivos y dependencias
# ===========================================
COPY requirements.txt /app/
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir gunicorn

COPY . /app

# ===========================================
# ‚è±Ô∏è Script de espera para MySQL
# ===========================================
COPY wait-for-it.sh /wait-for-it.sh
RUN chmod +x /wait-for-it.sh

# ===========================================
# üöÄ Comando de ejecuci√≥n din√°mico
# ===========================================
# üëâ Si FLASK_ENV=production -> Gunicorn
# üëâ Si FLASK_ENV=development -> Flask (auto-reload)
CMD ["/bin/bash", "-c", "\
if [ \"$FLASK_ENV\" = 'production' ]; then \
    echo 'üöÄ Running in PRODUCTION mode (Gunicorn)'; \
    /wait-for-it.sh db:3306 -- gunicorn --workers=3 --timeout=120 --bind=0.0.0.0:5000 main:app; \
else \
    echo '‚öôÔ∏è  Running in DEVELOPMENT mode (Flask)'; \
    /wait-for-it.sh db:3306 -- flask run --host=0.0.0.0; \
fi"]
